<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Platform · Cast Dashboard</title>
<link rel="icon" type="image/x-icon" href="/PracticeBase/img/icon-512.png">

<!-- Lucide icons -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
/* GLOBAL RESET */
*, *::before, *::after { box-sizing: border-box; }

/* DESIGN SYSTEM */
:root{
  --bg:#f5f5f7;
  --card:#fff;
  --soft:#fafafa;
  --text:#111;
  --muted:#666;
  --accent:#000;
  --border:#ddd;
  --radius-md:12px;
  --radius-lg:16px;
  --pill:999px;
  --shadow:0 8px 20px rgba(0,0,0,0.06);
  --space-2:8px;
  --space-3:12px;
  --space-4:16px;
}

/* LAYOUT */
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
body{display:flex;background:var(--bg);color:var(--text);height:100vh;overflow:hidden}

/* SIDEBAR */
.sidebar{
  width:260px;
  background:var(--card);
  border-right:1px solid var(--border);
  padding:var(--space-4);
  display:flex;
  flex-direction:column;
  gap:var(--space-3);
}
.logo{font-weight:700;font-size:1.15rem;margin-bottom:6px}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--radius-md);cursor:pointer;font-weight:600;border:2px solid transparent;
}
.nav-item:hover{background:#f0f0f0}
.nav-item.active{background:var(--soft);border-color:var(--accent)}
.nav-icon{width:18px;height:18px}

/* MAIN */
.main{flex:1;overflow:auto;padding:var(--space-4)}
.header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.section-title{font-size:1.25rem;margin:0}
.section-sub{margin:0;color:var(--muted);font-size:0.95rem}

/* CARD */
.card{background:var(--card);border-radius:var(--radius-lg);padding:var(--space-4);border:1px solid var(--border);box-shadow:var(--shadow);margin-bottom:var(--space-4)}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:var(--space-4)}

/* FORM */
.field{margin-bottom:var(--space-3)}
.field label{display:block;font-size:0.8rem;margin-bottom:6px;color:var(--muted)}
.field input,.field textarea{width:100%;padding:10px;border-radius:var(--radius-md);border:1px solid #ccc;font-size:0.95rem;background:#fff}
.field textarea{min-height:90px;resize:vertical}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:10px;padding:8px 14px;border-radius:var(--pill);background:var(--accent);color:#fff;border:2px solid var(--accent);cursor:pointer;font-weight:700}
.btn.outline{background:#fff;color:#000}
.btn:disabled{opacity:0.6;cursor:not-allowed}

/* SPINNER */
.spinner{width:16px;height:16px;border:3px solid rgba(255,255,255,0.35);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;display:none}
.spinner.dark{border:3px solid rgba(0,0,0,0.15);border-top-color:#000}

/* PAGE LOADER */
.page-loader{width:40px;height:40px;border:4px solid #ccc;border-top-color:#000;border-radius:50%;animation:spin .8s linear infinite;margin:40px auto}

@keyframes spin{to{transform:rotate(360deg)}}

/* LISTS */
.list{display:flex;flex-direction:column;gap:10px}
.list-item{background:var(--soft);padding:10px;border-radius:10px;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.pill{padding:4px 8px;border-radius:999px;border:1px solid #000;font-size:0.8rem}

/* CHAT */
.chat-box{display:flex;gap:10px;margin-top:12px}
.chat-box input{flex:1;padding:10px;border-radius:10px;border:1px solid #ccc}
.chat-message { width:100%; display:flex; gap:12px; align-items:flex-start; }
.chat-meta { font-size:0.85rem; color:var(--muted); margin-top:4px; }
.chat-actions { display:flex; gap:8px; align-items:center; }

/* EDIT UI */
.msg-edit { display:flex; gap:8px; margin-top:8px; }
.msg-edit input { flex:1; padding:8px; border-radius:8px; border:1px solid #ccc; }

/* STATUS */
.status{margin-top:8px;color:#0a7a2f;font-size:0.9rem;min-height:1em}
.small{font-size:0.85rem;color:var(--muted)}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">Platform</div>

  <div class="nav-item active" data-section="announcements">
    <i data-lucide="megaphone" class="nav-icon"></i> Announcements
  </div>

  <div class="nav-item" data-section="schedule">
    <i data-lucide="calendar" class="nav-icon"></i> Rehearsals
  </div>

  <div class="nav-item" data-section="tracks">
    <i data-lucide="music" class="nav-icon"></i> Tracks
  </div>

  <div class="nav-item" data-section="videos">
    <i data-lucide="video" class="nav-icon"></i> Videos
  </div>

  <div class="nav-item" data-section="script">
    <i data-lucide="file-text" class="nav-icon"></i> Script
  </div>

  <div class="nav-item" data-section="chat">
    <i data-lucide="message-circle" class="nav-icon"></i> Chat
  </div>

  <div style="flex:1"></div>

  <div class="nav-item" id="logoutBtn">
    <i data-lucide="log-out" class="nav-icon"></i> Sign out
  </div>
</div>

<!-- MAIN -->
<div class="main" id="main"></div>

<script type="module">
/* ====== Firebase imports
   Assumes ./firebase.js exports:
   auth, db, onAuthStateChanged, signOut,
   collection, addDoc, serverTimestamp,
   doc, getDoc, onSnapshot, query, orderBy,
   updateDoc, deleteDoc, setDoc
*/
import {
  auth, db, onAuthStateChanged, signOut,
  collection, addDoc, serverTimestamp,
  doc, getDoc, onSnapshot, query, orderBy,
  updateDoc, deleteDoc, setDoc
} from "./firebase.js";

/* INIT ICONS */
lucide.createIcons();

/* GLOBAL STATE */
let currentUser = null;
let currentUserEmail = null;
let currentUserIsAdmin = false;
let lastSeenChatTimestamp = 0;

/* AUTH CHECK */
onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "index";
    return;
  }
  currentUser = user;
  currentUserEmail = user.email || null;

  // Ensure user doc exists and read role
  try {
    const udoc = await getDoc(doc(db,"users",user.uid));
    if (!udoc.exists()) {
      await setDoc(doc(db,"users",user.uid), { email: user.email || "", role: "cast" });
      currentUserIsAdmin = false;
    } else {
      currentUserIsAdmin = (udoc.data().role === "admin");
    }
  } catch (err) {
    console.error("Error reading user doc:", err);
    currentUserIsAdmin = false;
  }
});

/* NAV */
const main = document.getElementById("main");
const navItems = Array.from(document.querySelectorAll(".nav-item[data-section]"));
const logoutBtn = document.getElementById("logoutBtn");

function setActive(section){
  navItems.forEach(n => n.classList.toggle("active", n.dataset.section === section));
}

navItems.forEach(item => {
  item.addEventListener("click", () => {
    const s = item.dataset.section;
    setActive(s);
    loadSection(s);
  });
});

logoutBtn.addEventListener("click", () => signOut(auth));

/* LOADER */
function showLoader(){
  main.innerHTML = `<div class="page-loader"></div>`;
}

/* INITIAL LOAD */
loadSection("announcements");

/* ESCAPE HTML helper */
function escapeHtml(str){
  if (!str) return "";
  return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
}

/* NOTIFICATIONS */
async function ensureNotificationPermission(){
  if (!("Notification" in window)) return false;
  if (Notification.permission === "granted") return true;
  if (Notification.permission === "denied") return false;
  try {
    const p = await Notification.requestPermission();
    return p === "granted";
  } catch {
    return false;
  }
}
function showDeviceNotification(title, body){
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") return;
  try {
    new Notification(title, { body, silent: false });
  } catch (e) {
    console.warn("Notification failed", e);
  }
}

/* MAIN SECTION LOADER */
function loadSection(section) {

  /* -------------------------
     ANNOUNCEMENTS
  -------------------------- */
  if (section === "announcements") {
    showLoader();

    setTimeout(() => {
      main.innerHTML = `
        <div class="header-row">
          <div>
            <h2 class="section-title">Announcements</h2>
            <p class="section-sub">Latest updates from the production team.</p>
          </div>
        </div>

        <div class="card">
          <div id="annList" class="list"></div>
        </div>
      `;

      const annList = document.getElementById("annList");

      onSnapshot(query(collection(db,"announcements"), orderBy("createdAt","desc")), snap => {
        annList.innerHTML = "";
        snap.forEach(d => {
          const x = d.data();
          const title = escapeHtml(x.title);
          const msg = escapeHtml(x.message);
          annList.innerHTML += `
            <div class="list-item">
              <div>
                <strong>${title}</strong>
                <div class="small">${msg}</div>
              </div>
            </div>
          `;
        });
      });

    }, 200);

    return;
  }

  /* -------------------------
     REHEARSALS
  -------------------------- */
  if (section === "schedule") {
    showLoader();

    setTimeout(() => {
      main.innerHTML = `
        <div class="header-row">
          <div>
            <h2 class="section-title">Rehearsals</h2>
            <p class="section-sub">Upcoming rehearsals (sorted by date).</p>
          </div>
        </div>

        <div class="card">
          <div id="schList" class="list"></div>
        </div>
      `;

      const schList = document.getElementById("schList");

      onSnapshot(query(collection(db,"schedule"), orderBy("sortTimestamp","asc")), snap => {
        schList.innerHTML = "";
        snap.forEach(d => {
          const x = d.data();
          const title = escapeHtml(x.title);
          const date = escapeHtml(x.date);
          const time = escapeHtml(x.time);
          const who = escapeHtml(x.who);
          const extra = escapeHtml(x.extra);

          schList.innerHTML += `
            <div class="list-item">
              <div>
                <strong>${title}</strong>
                <div class="small">${date} • ${time} • ${who}</div>
                ${extra ? `<div class="small">${extra}</div>` : ""}
              </div>
              <div class="pill">${date}</div>
            </div>
          `;
        });
      });

    }, 200);

    return;
  }

  /* -------------------------
     TRACKS
  -------------------------- */
  if (section === "tracks") {
    showLoader();

    setTimeout(() => {
      main.innerHTML = `
        <div class="header-row">
          <div>
            <h2 class="section-title">Tracks</h2>
            <p class="section-sub">Audio tracks for rehearsals and performances.</p>
          </div>
        </div>

        <div class="card">
          <div id="trkList" class="list"></div>
        </div>
      `;

      const trkList = document.getElementById("trkList");

      onSnapshot(query(collection(db,"tracks"), orderBy("createdAt","desc")), snap => {
        trkList.innerHTML = "";
        snap.forEach(d => {
          const x = d.data();
          const title = escapeHtml(x.title);
          const url = x.url || "";
          trkList.innerHTML += `
            <div class="list-item">
              <div><strong>${title}</strong></div>
              <div><a href="${escapeHtml(url)}" target="_blank" class="pill">Open</a></div>
            </div>
          `;
        });
      });

    }, 200);

    return;
  }

  /* -------------------------
     VIDEOS
  -------------------------- */
  if (section === "videos") {
    showLoader();

    setTimeout(() => {
      main.innerHTML = `
        <div class="header-row">
          <div>
            <h2 class="section-title">Videos</h2>
            <p class="section-sub">Reference and choreography videos.</p>
          </div>
        </div>

        <div class="card">
          <div id="vidList" class="list"></div>
        </div>
      `;

      const vidList = document.getElementById("vidList");

      onSnapshot(query(collection(db,"videos"), orderBy("createdAt","desc")), snap => {
        vidList.innerHTML = "";
        snap.forEach(d => {
          const x = d.data();
          const title = escapeHtml(x.title);
          const url = x.url || "";
          vidList.innerHTML += `
            <div class="list-item">
              <div><strong>${title}</strong></div>
              <div><a href="${escapeHtml(url)}" target="_blank" class="pill">Open</a></div>
            </div>
          `;
        });
      });

    }, 200);

    return;
  }

  /* -------------------------
     SCRIPT
  -------------------------- */
  if (section === "script") {
    showLoader();

    setTimeout(async () => {
      const scriptDoc = await getDoc(doc(db,"settings","script"));
      const url = scriptDoc.exists() ? scriptDoc.data().url : null;

      main.innerHTML = `
        <div class="header-row">
          <div>
            <h2 class="section-title">Script</h2>
            <p class="section-sub">Open the canonical script for the production.</p>
          </div>
        </div>

        <div class="card">
          ${url ? `<a href="${escapeHtml(url)}" target="_blank" class="btn outline">Open Script</a>` : `<div class="small">No script uploaded yet.</div>`}
        </div>
      `;
    }, 200);

    return;
  }

  /* -------------------------
     CHAT (everyone)
     - Everyone can read and create messages
     - Admins see Edit + Delete controls
  -------------------------- */
  if (section === "chat") {
    showLoader();

    setTimeout(async () => {
      main.innerHTML = `
        <div class="header-row">
          <div>
            <h2 class="section-title">Chat</h2>
            <p class="section-sub">Talk with your castmates. Admins can edit or delete messages.</p>
          </div>
          <div>
            <button id="notifyBtn" class="btn outline">Enable Notifications</button>
          </div>
        </div>

        <div class="card">
          <div id="chatList" class="list" style="max-height:420px; overflow:auto;"></div>

          <div class="chat-box">
            <input id="chatInput" placeholder="Type a message...">
            <button id="chatSend" class="btn"><span class="btn-text">Send</span></button>
          </div>
        </div>
      `;

      const chatList = document.getElementById("chatList");
      const chatInput = document.getElementById("chatInput");
      const chatSend = document.getElementById("chatSend");
      const notifyBtn = document.getElementById("notifyBtn");

      // enable notifications on user action
      notifyBtn.onclick = async () => {
        const ok = await ensureNotificationPermission();
        notifyBtn.textContent = ok ? "Notifications Enabled" : "Enable Notifications";
      };

      // track last seen timestamp to avoid duplicate notifications
      lastSeenChatTimestamp = Date.now();

      // listen for chat changes and show admin controls if current user is admin
      onSnapshot(query(collection(db,"chat"), orderBy("createdAt","asc")), snap => {
        // handle doc changes for notifications
        snap.docChanges().forEach(change => {
          if (change.type === "added") {
            const data = change.doc.data();
            const ts = data.createdAt && data.createdAt.toMillis ? data.createdAt.toMillis() : (data.createdAt || Date.now());
            // notify only if newer than lastSeen and not from current user
            if (ts > lastSeenChatTimestamp && data.user !== currentUserEmail) {
              showDeviceNotification(`New message from ${data.user}`, data.text);
            }
          }
        });

        chatList.innerHTML = "";
        snap.forEach(d => {
          const x = d.data();
          const id = d.id;
          const user = escapeHtml(x.user);
          const text = escapeHtml(x.text);
          const isOwner = (currentUserEmail && x.user === currentUserEmail);
          const isAdmin = currentUserIsAdmin;

          // message container
          const actions = [];
          if (isAdmin) actions.push(`<button class="btn outline" data-action="edit" data-id="${id}">Edit</button>`);
          if (isAdmin || isOwner) actions.push(`<button class="btn outline" data-action="delete" data-id="${id}">Delete</button>`);

          chatList.innerHTML += `
            <div class="list-item" data-id="${id}">
              <div class="chat-message">
                <div style="min-width:140px;">
                  <strong>${user}</strong>
                  <div class="chat-meta">${x.createdAt && x.createdAt.toDate ? x.createdAt.toDate().toLocaleString() : ""}</div>
                </div>
                <div style="flex:1;">
                  <div class="msg-text" data-id="${id}">${text}</div>
                  <div class="msg-edit-area" data-id="${id}"></div>
                </div>
                <div class="chat-actions">
                  ${actions.join("")}
                </div>
              </div>
            </div>
          `;
        });

        // attach action handlers
        chatList.querySelectorAll("button[data-action]").forEach(btn => {
          btn.onclick = async (e) => {
            const action = btn.dataset.action;
            const id = btn.dataset.id;
            if (action === "delete") {
              if (!confirm("Delete this message?")) return;
              try {
                await deleteDoc(doc(db,"chat",id));
              } catch (err) {
                console.error("Delete failed", err);
                alert("Delete failed");
              }
            } else if (action === "edit") {
              // only admins should see this button; show inline edit UI
              const container = chatList.querySelector(`.msg-edit-area[data-id="${id}"]`);
              const msgTextEl = chatList.querySelector(`.msg-text[data-id="${id}"]`);
              if (!container || !msgTextEl) return;
              const currentText = msgTextEl.textContent || "";
              container.innerHTML = `
                <div class="msg-edit">
                  <input type="text" class="msg-edit-input" value="${escapeHtml(currentText)}">
                  <button class="btn outline save-edit" data-id="${id}">Save</button>
                  <button class="btn outline cancel-edit" data-id="${id}">Cancel</button>
                </div>
              `;
              const saveBtn = container.querySelector(".save-edit");
              const cancelBtn = container.querySelector(".cancel-edit");
              const input = container.querySelector(".msg-edit-input");

              cancelBtn.onclick = () => { container.innerHTML = ""; };
              saveBtn.onclick = async () => {
                const newText = input.value.trim();
                if (!newText) { alert("Message cannot be empty"); return; }
                try {
                  await updateDoc(doc(db,"chat",id), { text: newText });
                  container.innerHTML = "";
                } catch (err) {
                  console.error("Update failed", err);
                  alert("Update failed");
                }
              };
            }
          };
        });

        // update lastSeenChatTimestamp to now after rendering
        lastSeenChatTimestamp = Date.now();
        // scroll to bottom
        chatList.scrollTop = chatList.scrollHeight;
      });

      // send message
      chatSend.onclick = async () => {
        const text = chatInput.value.trim();
        if (!text) return;
        const username = currentUserEmail || "User";
        try {
          await addDoc(collection(db, "chat"), {
            user: username,
            text,
            createdAt: serverTimestamp()
          });
          chatInput.value = "";
        } catch (err) {
          console.error("Send failed", err);
          alert("Message failed to send");
        }
      };

      chatInput.addEventListener("keypress", e => {
        if (e.key === "Enter") chatSend.click();
      });

      // prompt for notification permission once UI is ready
      ensureNotificationPermission();

    }, 200);

    return;
  }

  /* fallback */
  main.innerHTML = `<div class="card"><div class="small">Select a section from the left.</div></div>`;
}
</script>
</body>
</html>

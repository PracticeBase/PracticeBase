<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Login ¬∑ Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --bg: #f5f5f7;
  --bg-card: #ffffff;
  --text: #111;
  --border: #ddd;
  --accent: #000;
  --radius-md: 12px;
  --radius-pill: 999px;
  --shadow-md: 0 8px 20px rgba(0,0,0,0.08);
}

body {
  margin:0;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
}

.card {
  background:var(--bg-card);
  padding:24px;
  border-radius:16px;
  box-shadow:var(--shadow-md);
  width:320px;
}

h2 {
  margin:0 0 16px;
  font-size:1.3rem;
  font-weight:700;
}

.input-wrap {
  position:relative;
  margin-bottom:14px;
}

input {
  width:100%;
  padding:12px;
  padding-right:40px;
  border-radius:var(--radius-md);
  border:1px solid #ccc;
  font-size:0.95rem;
  box-sizing:border-box; /* FIXES the ‚Äúslightly too long‚Äù issue */
}

.eye-btn {
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  cursor:pointer;
  font-size:1.1rem;
  opacity:0.6;
}

button {
  width:100%;
  padding:12px;
  border-radius:var(--radius-pill);
  border:2px solid var(--accent);
  background:var(--accent);
  color:#fff;
  font-weight:600;
  font-size:1rem;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
}

button:disabled {
  opacity:0.6;
  cursor:default;
}

.loader {
  width:16px;
  height:16px;
  border:3px solid rgba(255,255,255,0.4);
  border-top-color:#fff;
  border-radius:50%;
  animation:spin 0.7s linear infinite;
  display:none;
}

@keyframes spin {
  to { transform:rotate(360deg); }
}

.error {
  margin-top:10px;
  font-size:0.85rem;
  color:#b00020;
  min-height:1em;
}
</style>
</head>

<body>
<div class="card">
  <h2>Sign in</h2>

  <div class="input-wrap">
    <input id="emailInput" type="email" placeholder="Email">
  </div>

  <div class="input-wrap">
    <input id="passwordInput" type="password" placeholder="Password">
    <div class="eye-btn" id="togglePassword">üëÅÔ∏è</div>
  </div>

  <button id="loginBtn">
    <span id="loginText">Continue</span>
    <div class="loader" id="loader"></div>
  </button>

  <div class="error" id="error"></div>
</div>

<script type="module">
import {
  auth,
  db,
  signInWithEmailAndPassword,
  doc,
  getDoc,
  setDoc
} from "./firebase.js";

const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const togglePassword = document.getElementById("togglePassword");
const loginBtn = document.getElementById("loginBtn");
const loginText = document.getElementById("loginText");
const loader = document.getElementById("loader");
const errorEl = document.getElementById("error");

/* -------------------------
   SHOW / HIDE PASSWORD
-------------------------- */
togglePassword.onclick = () => {
  const isHidden = passwordInput.type === "password";
  passwordInput.type = isHidden ? "text" : "password";
  togglePassword.textContent = isHidden ? "üôà" : "üëÅÔ∏è";
};

/* -------------------------
   LOGIN HANDLER
-------------------------- */
loginBtn.onclick = async () => {
  errorEl.textContent = "";
  loginBtn.disabled = true;
  loader.style.display = "block";
  loginText.textContent = "Loading‚Ä¶";

  try {
    const emailValue = emailInput.value.trim();
    const passwordValue = passwordInput.value;

    const cred = await signInWithEmailAndPassword(auth, emailValue, passwordValue);
    const uid = cred.user.uid;

    // Ensure user doc exists
    const userRef = doc(db, "users", uid);
    const snap = await getDoc(userRef);

    if (!snap.exists()) {
      await setDoc(userRef, {
        email: cred.user.email,
        role: "cast"
      });
    }

    const data = (await getDoc(userRef)).data();
    const role = data.role || "cast";

    if (role === "admin") {
      window.location.href = "admin";
    } else {
      window.location.href = "platform";
    }

  } catch (err) {
    errorEl.textContent = err.message || "Login failed";
  } finally {
    loginBtn.disabled = false;
    loader.style.display = "none";
    loginText.textContent = "Continue";
  }
};
</script>
</body>
</html>

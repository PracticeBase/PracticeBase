<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin · Platform</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ICON CDN -->
<script src="https://unpkg.com/lucide@latest"></script>

<style>
/* GLOBAL RESET — fixes input width issues everywhere */
*,
*::before,
*::after {
  box-sizing: border-box;
}

/* DESIGN SYSTEM */
:root {
  --bg: #f5f5f7;
  --bg-card: #ffffff;
  --bg-soft: #fafafa;

  --text: #111;
  --text-sub: #555;

  --border: #ddd;
  --accent: #000;

  --radius-md: 12px;
  --radius-lg: 16px;
  --radius-pill: 999px;

  --shadow-md: 0 8px 20px rgba(0,0,0,0.08);

  --space-2: 8px;
  --space-3: 12px;
  --space-4: 16px;
  --space-5: 20px;
}

/* GLOBAL */
body {
  margin: 0;
  background: var(--bg);
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color: var(--text);
  display: flex;
  height: 100vh;
  overflow: hidden;
}

/* SIDEBAR */
.sidebar {
  width: 240px;
  background: #fff;
  border-right: 1px solid var(--border);
  padding: var(--space-4) var(--space-3);
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.logo {
  font-weight: 700;
  font-size: 1.2rem;
  margin-bottom: var(--space-4);
}

.nav-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 600;
  border: 2px solid transparent;
}

.nav-item.active {
  border-color: var(--accent);
  background: var(--bg-soft);
}

.nav-item:hover {
  background: #eee;
}

.nav-icon {
  width: 20px;
  height: 20px;
}

/* MAIN AREA */
.main {
  flex: 1;
  overflow: auto;
  padding: var(--space-4);
}

.section-title {
  font-size: 1.3rem;
  font-weight: 700;
  margin: 0 0 var(--space-2);
}

.section-sub {
  margin: 0 0 var(--space-4);
  font-size: 0.9rem;
  color: var(--text-sub);
}

/* CARDS */
.card {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  padding: var(--space-4);
  border: 1px solid var(--border);
  box-shadow: var(--shadow-md);
  margin-bottom: var(--space-4);
}

/* GRID */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: var(--space-4);
}

/* FIXED INPUTS — no more overflow */
.field {
  margin-bottom: var(--space-3);
}

.field label {
  display: block;
  font-size: 0.75rem;
  margin-bottom: 4px;
}

.field input,
.field textarea {
  width: 100%;
  padding: var(--space-2);
  border-radius: var(--radius-md);
  border: 1px solid #ccc;
  font-size: 0.85rem;
  background: #fff;
}

/* BUTTONS */
.btn {
  border-radius: var(--radius-pill);
  border: 2px solid var(--accent);
  background: var(--accent);
  color: #fff;
  padding: 8px 14px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
}

.btn.outline {
  background: #fff;
  color: #000;
}

/* BUTTON LOADER */
.spinner {
  width: 16px;
  height: 16px;
  border: 3px solid rgba(255,255,255,0.4);
  border-top-color: #fff;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
  display: none;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* PAGE LOADER */
.page-loader {
  width: 40px;
  height: 40px;
  border: 4px solid #ccc;
  border-top-color: #000;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 40px auto;
}

/* LISTS */
.list {
  display: flex;
  flex-direction: column;
  gap: var(--space-2);
}

.list-item {
  background: var(--bg-soft);
  padding: var(--space-3);
  border-radius: var(--radius-md);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.pill {
  border: 1px solid #000;
  padding: 2px 8px;
  border-radius: var(--radius-pill);
  font-size: 0.75rem;
}

/* STATUS TEXT */
.status {
  margin-top: var(--space-2);
  font-size: 0.8rem;
  color: #0a7a2f;
  min-height: 1em;
}

</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar">
  <div class="logo">Admin</div>

  <div class="nav-item active" data-section="add">
    <i data-lucide="plus" class="nav-icon"></i> Add Content
  </div>

  <div class="nav-item" data-section="view">
    <i data-lucide="file-text" class="nav-icon"></i> View All
  </div>

  <div class="nav-item" data-section="users">
    <i data-lucide="users" class="nav-icon"></i> Users
  </div>

  <div class="nav-item" id="logoutBtn">
    <i data-lucide="log-out" class="nav-icon"></i> Sign out
  </div>
</div>

<!-- MAIN -->
<div class="main" id="main"></div>

<script type="module">
import {
  auth, db, onAuthStateChanged, signOut,
  collection, addDoc, serverTimestamp
} from "./firebase.js";
import {
  doc, setDoc, getDoc, onSnapshot, query, orderBy, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

/* INIT ICONS */
lucide.createIcons();

/* AUTH CHECK */
onAuthStateChanged(auth, async user => {
  if (!user) {
    window.location.href = "index";
    return;
  }

  const roleDoc = await getDoc(doc(db, "users", user.uid));
  if (!roleDoc.exists() || roleDoc.data().role !== "admin") {
    window.location.href = "platform";
  }
});

/* LOGOUT */
logoutBtn.onclick = () => signOut(auth);

/* NAVIGATION */
const main = document.getElementById("main");
const navItems = [...document.querySelectorAll(".nav-item[data-section]")];

function setActive(section) {
  navItems.forEach(i => i.classList.toggle("active", i.dataset.section === section));
}

navItems.forEach(item => {
  item.onclick = () => {
    setActive(item.dataset.section);
    loadSection(item.dataset.section);
  };
});

/* INITIAL LOAD */
loadSection("add");

/* SECTION LOADER */
function showLoader() {
  main.innerHTML = `<div class="page-loader"></div>`;
}

/* MAIN SECTION HANDLER */
function loadSection(section) {

  /* -------------------------
     ADD CONTENT
  -------------------------- */
  if (section === "add") {
    main.innerHTML = `
      <h1 class="section-title">Add Content</h1>
      <p class="section-sub">Create announcements, rehearsals, tracks, videos, and script links.</p>

      <div class="grid">

        <div class="card">
          <h2>Add Announcement</h2>
          <div class="field"><label>Title</label><input id="annTitle"></div>
          <div class="field"><label>Message</label><textarea id="annMessage" rows="3"></textarea></div>
          <button class="btn" id="annAddBtn">
            <span class="btn-text">Add</span>
            <div class="spinner"></div>
          </button>
          <div class="status" id="annStatus"></div>
        </div>

        <div class="card">
          <h2>Add Rehearsal</h2>
          <div class="field"><label>Title</label><input id="schTitle"></div>
          <div class="field"><label>Date</label><input id="schDate" placeholder="2026-02-01"></div>
          <div class="field"><label>Time</label><input id="schTime" placeholder="18:00–21:00"></div>
          <button class="btn" id="schAddBtn">
            <span class="btn-text">Add</span>
            <div class="spinner"></div>
          </button>
          <div class="status" id="schStatus"></div>
        </div>

        <div class="card">
          <h2>Add Track</h2>
          <div class="field"><label>Title</label><input id="trkTitle"></div>
          <div class="field"><label>URL</label><input id="trkUrl"></div>
          <button class="btn" id="trkAddBtn">
            <span class="btn-text">Add</span>
            <div class="spinner"></div>
          </button>
          <div class="status" id="trkStatus"></div>
        </div>

        <div class="card">
          <h2>Add Video</h2>
          <div class="field"><label>Title</label><input id="vidTitle"></div>
          <div class="field"><label>URL</label><input id="vidUrl"></div>
          <button class="btn" id="vidAddBtn">
            <span class="btn-text">Add</span>
            <div class="spinner"></div>
          </button>
          <div class="status" id="vidStatus"></div>
        </div>

        <div class="card">
          <h2>Script URL</h2>
          <div class="field"><label>URL</label><input id="scriptUrl"></div>
          <button class="btn" id="scriptSaveBtn">
            <span class="btn-text">Save</span>
            <div class="spinner"></div>
          </button>
          <div class="status" id="scriptStatus"></div>
        </div>

      </div>
    `;

    /* BUTTON LOADING HELPERS */
    function startLoading(btn) {
      btn.querySelector(".btn-text").style.opacity = "0";
      btn.querySelector(".spinner").style.display = "block";
      btn.disabled = true;
    }
    function stopLoading(btn) {
      btn.querySelector(".btn-text").style.opacity = "1";
      btn.querySelector(".spinner").style.display = "none";
      btn.disabled = false;
    }

    /* ADD LOGIC */
    annAddBtn.onclick = async () => {
      startLoading(annAddBtn);
      await addDoc(collection(db,"announcements"),{
        title:annTitle.value,
        message:annMessage.value,
        createdAt:serverTimestamp()
      });
      annTitle.value = annMessage.value = "";
      annStatus.textContent = "Added!";
      stopLoading(annAddBtn);
    };

    schAddBtn.onclick = async () => {
      startLoading(schAddBtn);
      await addDoc(collection(db,"schedule"),{
        title:schTitle.value,
        date:schDate.value,
        time:schTime.value,
        createdAt:serverTimestamp()
      });
      schTitle.value = schDate.value = schTime.value = "";
      schStatus.textContent = "Added!";
      stopLoading(schAddBtn);
    };

    trkAddBtn.onclick = async () => {
      startLoading(trkAddBtn);
      await addDoc(collection(db,"tracks"),{
        title:trkTitle.value,
        url:trkUrl.value,
        createdAt:serverTimestamp()
      });
      trkTitle.value = trkUrl.value = "";
      trkStatus.textContent = "Added!";
      stopLoading(trkAddBtn);
    };

    vidAddBtn.onclick = async () => {
      startLoading(vidAddBtn);
      await addDoc(collection(db,"videos"),{
        title:vidTitle.value,
        url:vidUrl.value,
        createdAt:serverTimestamp()
      });
      vidTitle.value = vidUrl.value = "";
      vidStatus.textContent = "Added!";
      stopLoading(vidAddBtn);
    };

    scriptSaveBtn.onclick = async () => {
      startLoading(scriptSaveBtn);
      await setDoc(doc(db,"settings","script"),{url:scriptUrl.value});
      scriptStatus.textContent = "Saved!";
      stopLoading(scriptSaveBtn);
    };

    return;
  }

  /* -------------------------
     VIEW EVERYTHING
  -------------------------- */
  if (section === "view") {
    showLoader();

    setTimeout(() => {
      main.innerHTML = `
        <h1 class="section-title">All Content</h1>
        <p class="section-sub">Announcements, rehearsals, tracks, videos, and chat.</p>

        <div class="grid">
          <div class="card"><h2>Announcements</h2><div id="annList" class="list"></div></div>
          <div class="card"><h2>Rehearsals</h2><div id="schList" class="list"></div></div>
          <div class="card"><h2>Tracks</h2><div id="trkList" class="list"></div></div>
          <div class="card"><h2>Videos</h2><div id="vidList" class="list"></div></div>
          <div class="card"><h2>Chat</h2><div id="chatList" class="list"></div></div>
        </div>
      `;

      onSnapshot(query(collection(db,"announcements"),orderBy("createdAt","desc")), snap=>{
        annList.innerHTML = "";
        snap.forEach(d=>{
          annList.innerHTML += `<div class="list-item"><span>${d.data().title}</span></div>`;
        });
      });

      onSnapshot(query(collection(db,"schedule"),orderBy("date","asc")), snap=>{
        schList.innerHTML = "";
        snap.forEach(d=>{
          const x=d.data();
          schList.innerHTML += `<div class="list-item"><span>${x.title}</span><span class="pill">${x.date}</span></div>`;
        });
      });

      onSnapshot(collection(db,"tracks"), snap=>{
        trkList.innerHTML = "";
        snap.forEach(d=>{
          trkList.innerHTML += `<div class="list-item"><span>${d.data().title}</span></div>`;
        });
      });

      onSnapshot(collection(db,"videos"), snap=>{
        vidList.innerHTML = "";
        snap.forEach(d=>{
          vidList.innerHTML += `<div class="list-item"><span>${d.data().title}</span></div>`;
        });
      });

      onSnapshot(query(collection(db,"chat"),orderBy("createdAt","asc")), snap=>{
        chatList.innerHTML = "";
        snap.forEach(d=>{
          const x=d.data();
          chatList.innerHTML += `<div class="list-item"><span>${x.user}: ${x.text}</span></div>`;
        });
      });

    }, 300);

    return;
  }

  /* -------------------------
     USER MANAGEMENT
  -------------------------- */
  if (section === "users") {
    showLoader();

    setTimeout(() => {
      main.innerHTML = `
        <h1 class="section-title">User Management</h1>
        <p class="section-sub">Promote, demote, or delete users.</p>

        <div class="card">
          <div id="usersList" class="list"><div>Loading…</div></div>
        </div>
      `;

      const usersList = document.getElementById("usersList");

      onSnapshot(collection(db, "users"), snap => {
        usersList.innerHTML = "";
        snap.forEach(docSnap => {
          const u = docSnap.data();
          const uid = docSnap.id;

          usersList.innerHTML += `
            <div class="list-item">
              <div>
                <strong>${u.email}</strong><br>
                <span style="font-size:0.8rem;color:#555;">${u.role}</span>
              </div>
              <div style="display:flex;gap:6px;">
                <button class="btn outline" onclick="promoteUser('${uid}')">Admin</button>
                <button class="btn outline" onclick="demoteUser('${uid}')">Cast</button>
                <button class="btn outline" onclick="deleteUser('${uid}')">Delete</button>
              </div>
            </div>
          `;
        });
      });

    }, 300);

    return;
  }
}

/* USER MANAGEMENT FUNCTIONS */
window.promoteUser = async (uid) => {
  await setDoc(doc(db, "users", uid), { role: "admin" }, { merge: true });
  alert("User promoted to admin");
};

window.demoteUser = async (uid) => {
  await setDoc(doc(db, "users", uid), { role: "cast" }, { merge: true });
  alert("User demoted to cast");
};

window.deleteUser = async (uid) => {
  if (!confirm("Delete this user?")) return;
  await deleteDoc(doc(db, "users", uid));
  alert("User deleted");
};
</script>

</body>
</html>
